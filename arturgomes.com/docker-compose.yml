version: '3.8'

services:
  arturgomes:
    build: .
    container_name: arturgomes
    restart: unless-stopped
    networks:
      - exposed
    labels:
      - "traefik.enable=true"
      # HTTP redirect to HTTPS
      - "traefik.http.routers.arturgomes.entrypoints=http"
      - "traefik.http.routers.arturgomes.rule=Host(`arturgomes.com`) || Host(`www.arturgomes.com`) || Host(`arturgomes.com.br`) || Host(`www.arturgomes.com.br`)"
      - "traefik.http.routers.arturgomes.middlewares=https-redirect"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      # HTTPS
      - "traefik.http.routers.arturgomes-secure.entrypoints=https"
      - "traefik.http.routers.arturgomes-secure.rule=Host(`arturgomes.com`) || Host(`www.arturgomes.com`) || Host(`arturgomes.com.br`) || Host(`www.arturgomes.com.br`)"
      - "traefik.http.routers.arturgomes-secure.tls=true"
      - "traefik.http.routers.arturgomes-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.arturgomes-secure.service=arturgomes"
      # Redirect all variants to arturgomes.com
      - "traefik.http.middlewares.arturgomes-redirect.redirectregex.regex=^https://(www\\.arturgomes\\.com|arturgomes\\.com\\.br|www\\.arturgomes\\.com\\.br)/(.*)"
      - "traefik.http.middlewares.arturgomes-redirect.redirectregex.replacement=https://arturgomes.com/$${2}"
      - "traefik.http.middlewares.arturgomes-redirect.redirectregex.permanent=true"
      - "traefik.http.routers.arturgomes-secure.middlewares=arturgomes-redirect"
      # Service
      - "traefik.http.services.arturgomes.loadbalancer.server.port=80"

networks:
  exposed:
    external: true
